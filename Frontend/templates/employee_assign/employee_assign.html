{% extends 'base/base_dashboard.html' %}

{% block title %}艾力克電機{% endblock %}

{% block import %}

{% load static%}
<link rel="stylesheet" href="{% static 'css/employee_assign/employee_assign.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.3.4/signature_pad.js"
    integrity="sha512-j36pYCzm3upwGd6JGq6xpdthtxcUtSf5yQJSsgnqjAsXtFT84WH8NQy9vqkv4qTV9hK782TwuHUTSwo2hRF+/A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

{% endblock %}


{% block main %}
<div class="main px-3">
    <div id="error-message"></div>
    <div class="employee-assign modal fade" id="employee-assign-modal" tabindex="-1" aria-labelledby="employee-assign"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="employee-assign-label">派工單</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container shadow-sm">
                        <form action="/restful/project_employee_assign" id="form" method="POST" class="pb-4"
                            data-method="post">
                            {% csrf_token %}
                            <input name="id" hidden />
                            <div class="form-row my-2">
                                <div class="col-12 col-md-6">
                                    <div class="form-row">
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="project_confirmation_control">工程確認單</label>
                                                <select class="form-control form-control-sm" name="project_job_assign"
                                                    id="project_job_assign_id">
                                                    <option value="-1">請選擇工程確認單</option>
                                                    {% for job_assign in all_project_job_assign %}
                                                    <option value="{{ job_assign.id }}">
                                                        {{job_assign.project_confirmation__project_confirmation_id }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="quotation_id_control">報價單號</label>
                                                <input class="form-control form-control-sm" readonly
                                                    id="quotation_id"></input>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="project_name_control">工程名稱</label>
                                                <input class="form-control form-control-sm" readonly
                                                    id="project_name"></input>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="client_control">客戶名稱</label>
                                                <input class="form-control form-control-sm" readonly
                                                    id="client"></input>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="requisition_control">請購單位</label>
                                                <input class="form-control form-control-sm" readonly
                                                    id="requisition"></input>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="equipment_type_control">施工日期</label>
                                                <input  type="date" class="form-control form-control-sm" name="construction_date"
                                                    id="construction_date_control"></input>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="equipment_name_control">完工日期</label>
                                                <input  type="date" class="form-control" name="completion_date"
                                                    id="completion_date"></input>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <div class="form-row">
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="is_completed">是否完工</label>
                                                <select class="form-control form-control-sm" name="is_completed"
                                                    id="is_completed" required>
                                                    <option value="true">是</option>
                                                    <option value="false">否</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="construction_location">施工地點</label>
                                                <input class="form-control form-control-sm" name="construction_location"
                                                    id="construction_location" required></input>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="inspector_select2">檢測人員</label>
                                                <select class="select2" data-placeholder="選擇工作人員" name="inspector"
                                                    id="inspector_select2" multiple>
                                                    {% for employee in employees_list %}
                                                    <option value="{{ employee.id }}">{{ employee.user__username }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="vehicle_select2">使用車輛</label>
                                                <select class="select2" data-placeholder="選擇車輛" name="vehicle"
                                                    id="vehicle_select2" multiple>
                                                    <option value="1">1</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">

                                        <div class="col-12 col-md-6">
                                            <div class="form-group">
                                                <label for="manuscript_return_date">手稿預計回傳日</label>
                                                <input class="form-control" name="manuscript_return_date"
                                                type="date"   id="manuscript_return_date"></input>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-row">


                                        <div class="form-row">
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <label for="equipment_type_control">業主簽名</label>
                                                    <input class="form-control form-control-sm" name="enterprise_signature"
                                                        id="enterprise_signature"></input>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--
                                    <div class="form-row">
                                        <div class="col-12">
                                            <div class="form-group">

                                                <label for="equipment_type_control">業主簽名</label>
                                                <div id="signature-pad">
                                                    <canvas></canvas>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                -->
                                </div>
                            </div>



                            <div class=" d-flex justify-content-between">
                                <button type="submit" class="btn border border-dark rounded w-50 mx-4 "
                                    style="color: #fff;background: #1E3050;">送出</button>
                                <button type="button" class="btn border border-dark rounded w-50 mx-4 "
                                    style="color: #fff;background: #1E3050;" data-dismiss="modal">關閉</button>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="employee-assign-table container-fluid shadow-sm table-responsive-lg">
        <table class="table table-sm table-hover text-center" id="table" data-toggle="table" data-sortable="true"
            data-toolbar="#toolbar" data-pagination="true" data-page-size="25" data-page-list="[25, All]" data-search="true"
            data-show-columns="true" data-filter-strict-search="true" data-show-columns-toggle-all="true">
            <div id="toolbar">
                <div class="employee-assign-header container-fluid">
                    <a href="" class="font-weight-bold" id="sys_new" data-toggle="modal"
                        data-target="#employee-assign-modal">
                        <i class="fa-solid fa-plus fa-sm" style="color: #000000;"></i> 新增派工單
                    </a>
                    <br>
                    <a href="" class="font-weight-bold" id="">
                        <i class="fa-solid fa-arrow-right-to-bracket" style="color: #000000;"></i> 匯入
                    </a>
                    <button onclick="exportAllOptionToExcel()"data-export-url="{% url 'excel_export' %}">匯出全部資料</button>
                    <button onclick="exportSelectedOptionToExcel()">匯出已選資料</button>
                </div>
                <thead class="thead-light" style="font-size: 14px;">
                    <tr class="text-nowrap">
                        <th data-force-hide="true"></th>
                        <th data-force-hide="true"></th>
                        <th data-field="quotation_id" data-sortable="true">報價單號</th>
                        <th data-field="project_name" data-sortable="true">工程名稱</th>
                        <th data-field="construction_date" data-sortable="true">施工日期</th>
                        <th data-field="completion_date" data-sortable="true">完工日期</th>
                        <th data-field="is_completed" data-sortable="true">是否完工</th>
                        <th data-field="client" data-sortable="true">客戶名稱</th>
                        <th data-field="requisition" data-sortable="true">請購單位</th>
                        <th data-field="created_date" data-sortable="true">施工地點</th>
                        <th data-field="created_date" data-sortable="true">檢測人員</th>
                        <th data-field="created_date" data-sortable="true">使用車輛</th>
                        <th data-field="created_date" data-sortable="true">資料登打人員</th>
                        <th data-field="created_date" data-sortable="true">手稿預計回傳日</th>
                        <th data-field="created_date" data-sortable="true">帶班主管</th>
                        <th data-field="created_date" data-sortable="true">填表人</th>
                        <th data-field="created_date" data-sortable="true">業主簽名</th>
                        <th data-field="created_date" data-sortable="true">建立日期</th>
                    </tr>
                </thead>
                <tbody style="font-size: 14px;">
                    {% for p in Project_Employee_Assign %}
                    <tr>
                        <td>
                            <a type="button" data-url="project_employee_assign" data-id="{{p.id}}"
                                class="sys_get btn btn-sm btn-warning my-2 mx-md-2" data-toggle="modal"
                                data-target="#employee-assign-modal"><i class="fas fa-sm fa-edit"></i></a>
                        </td>
                        <td>
                            <a data-url="project_employee_assign" data-id="{{p.id}}" type="button"
                                class="sys_del btn btn-sm btn-danger my-2 mx-md-2"><i
                                    class="far fa-sm fa-trash-alt"></i></a>
                        </td>

                        <td>{{ p.project_job_assign.project_confirmation.quotation_id }}</td>
                        <td>{{ p.project_job_assign.project_confirmation.project_name }}</td>
                        <td>{{ p.construction_date }}</td>
                        <td>{{ p.completion_date }}</td>
                        <td>{{ p.is_completed }}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% empty %}

                    <h2>
                        目前無資料
                    </h2>
                    {% endfor %}

                </tbody>
        </table>
    </div>
</div>


<style>
    /* 設定簽名板的寬度和高度，並添加邊框 */
    #signature-pad {
        width: 400px;
        height: 200px;
        border: 2px solid #ccc;
    }

    /* 設定簽名板內 canvas 的寬度和高度，使其填滿整個簽名板 */
    #signature-pad canvas {
        width: 100%;
        height: 100%;
    }
</style>
<script>
    function exportAllOptionToExcel() {
        var exportUrl = document.querySelector('button[data-export-url]').getAttribute('data-export-url');
        var tableData = [];
        var rows = document.getElementById("table").rows;
        var headers = [];
        for (var i = 3; i < rows[0].cells.length; i++) {
            headers.push(rows[0].cells[i].innerText);
        }
        
        for (var i = 1; i < rows.length; i++) {
            var rowData = {};
            for (var j = 0, k = 3; j < headers.length; j++,k++) {
            rowData[headers[j]] = rows[i].cells[k].innerText;
            }
            tableData.push(rowData);
        }
        fetch(exportUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken, 
            },
            body: JSON.stringify({
                headers: headers,
                data: tableData,
            }),
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(new Blob([blob]));
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = '派工單.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error:', error));
    }
</script>
<script>
    function exportSelectedOptionToExcel() {
        console.log(getSelectedValues())
        var exportUrl = document.querySelector('button[data-export-url]').getAttribute('data-export-url');
        var tableData = [];
        var rows = document.getElementById("table").rows;
        var headers = [];
        for (var i = 3; i < rows[0].cells.length; i++) {
            headers.push(rows[0].cells[i].innerText);
        }
        
        for (var i = 1; i < rows.length; i++) {
            var checkbox = rows[i].querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                console.log(checkbox.value)
                var rowData = {};
                for (var j = 0, k = 3; j < headers.length; j++,k++) {
                    rowData[headers[j]] = rows[i].cells[k].innerText;
                }
                tableData.push(rowData);
            }
        }
        console.log(headers)
        console.log(tableData)
        fetch(exportUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken, 
            },
            body: JSON.stringify({
                headers: headers,
                data: tableData,
            }),
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(new Blob([blob]));
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = '派工單.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        })
        .catch(error => console.error('Error:', error));
    }
</script>
<script>


    document.addEventListener('DOMContentLoaded', function () {
        var scripts = [
            "{% static 'js/fuc/restful.js' %}",
            "{% static 'js/employee_assign/employee_assign.js' %}",
        ];

        scripts.forEach(function (src) {
            var script = document.createElement('script');
            script.src = src;
            document.body.appendChild(script);
        });
    });
</script>


{% endblock %}