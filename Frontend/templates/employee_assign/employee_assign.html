{% extends 'base/base_dashboard.html' %}

{% block title %}艾力克電機{% endblock %}

{% block import %}

{% load static%}
<link rel="stylesheet" href="{% static 'css/employee_assign/employee_assign.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.3.4/signature_pad.js"
    integrity="sha512-j36pYCzm3upwGd6JGq6xpdthtxcUtSf5yQJSsgnqjAsXtFT84WH8NQy9vqkv4qTV9hK782TwuHUTSwo2hRF+/A=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

{% endblock %}


{% block main %}

<div class="modal fade" id="signatureModal" tabindex="-1" role="dialog" aria-labelledby="signatureModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signatureModalLabel">電子簽名</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <canvas id="mycanvas" width="900"  height="400"></canvas>
                <div id="image"></div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="clear">清除</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
                <button type="button" class="btn btn-primary" id="convertToImage">保存簽名</button>
            </div>
        </div>
    </div>
</div>

<style>
    #signatureModal .modal-dialog {
    max-width: 800px; /* 更改为您希望的宽度 */
}

#mycanvas {
    width: 100%; /* 使用百分比来占据父容器的宽度 */
    max-width: 100%; /* 防止 canvas 溢出 */
    height: auto; /* 根据比例自适应高度 */
}

    canvas {
        background: #eee;
    }

    #image {
        img {
            display: block;
            width: 100%;
            height: 200px;
        }
    }


</style>


<div class="main px-3">
    <div id="error-message"></div>
    <div class="employee-assign modal fade" id="employee-assign-modal" tabindex="-1" aria-labelledby="employee-assign"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="employee-assign-label">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" data-target="#none_equipment_tab">派工單</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" data-target="#equipment_tab">攜帶儀器</a>
                            </li>
                        </ul>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container shadow-sm">
                        <form action="/restful/project_employee_assign" id="form" method="POST" class="pb-4"
                            data-method="post">
                            {% csrf_token %}

                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="none_equipment_tab">
                                    <input name="id" hidden />
                                    <select multiple id="carry_equipments_select2" style="display: none;"
                                        name="carry_equipments">
                                        {% for e in all_Equipment %}
                                        <option value="{{ e.id }}">{{e.id}}</option>
                                        {% endfor %}
                                    </select>

                                    <div class="form-row my-2">
                                        <div class="col-12 col-md-6">
                                            <div class="form-row">
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="project_confirmation_control">工程確認單</label>
                                                        <select class="form-control form-control-sm"
                                                            name="project_job_assign" id="project_job_assign_id">
                                                            <option value="-1">請選擇工作派任計畫</option>
                                                            {% for job_assign in all_project_job_assign %}
                                                            <option value="{{ job_assign.id }}">
                                                                {{job_assign.project_confirmation__project_confirmation_id}}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="lead_employee">帶班主管</label>
                                                        <select class="select2" data-placeholder="選擇帶班主管"
                                                            name="lead_employee" id="lead_employee_select2" multiple>
                                                            {% for employee in employees_list %}
                                                            <option value="{{ employee.id }}">
                                                                {{employee.user__username}}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-6">
                                                    <div class="form-group">
                                                        <label for="quotation_id_control">報價單號</label>
                                                        <input class="form-control form-control-sm" readonly
                                                            id="quotation_id"></input>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="form-group">
                                                        <label for="project_name_control">工程名稱</label>
                                                        <input class="form-control form-control-sm" readonly
                                                            id="project_name"></input>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-6">
                                                    <div class="form-group">
                                                        <label for="client_control">客戶名稱</label>
                                                        <input class="form-control form-control-sm" readonly
                                                            id="client"></input>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="form-group">
                                                        <label for="requisition_control">請購單位</label>
                                                        <input class="form-control form-control-sm" readonly
                                                            id="requisition"></input>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="equipment_type_control">施工日期</label>
                                                        <input type="date" class="form-control form-control-sm"
                                                            name="construction_date"
                                                            id="construction_date_control"></input>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="equipment_name_control">完工日期</label>
                                                        <input type="date" class="form-control" name="completion_date"
                                                            id="completion_date"></input>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="form-row">
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="is_completed">是否完工</label>
                                                        <select class="form-control form-control-sm" name="is_completed"
                                                            id="is_completed" required>
                                                            <option value="true">是</option>
                                                            <option value="false">否</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="construction_location">施工地點</label>
                                                        <input class="form-control form-control-sm"
                                                            name="construction_location" id="construction_location"
                                                            required></input>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row">
                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="inspector_select2">檢測人員</label>
                                                        <select class="select2" data-placeholder="選擇工作人員"
                                                            name="inspector" id="inspector_select2" multiple>
                                                            {% for employee in employees_list %}
                                                            <option value="{{ employee.id }}">
                                                                {{employee.user__username}}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                   
                                                </div>
                                            </div>
                                            <div class="form-row">

                                                <div class="col-12 col-md-6">
                                                    <div class="form-group">
                                                        <label for="manuscript_return_date">手稿預計回傳日</label>
                                                        <input class="form-control" name="manuscript_return_date"
                                                            type="date" id="manuscript_return_date"></input>
                                                    </div>
                                                </div>
                                            </div>
                                     

                                        </div>
                                    </div>

                                </div>
                                <div class="tab-pane fade" id="equipment_tab">
                                    <div class="project-confirmation-table container-fluid shadow-sm table-responsive"
                                        style="min-height: 400px;">
                                        <table id="Equipment_table" class="table table-sm table-hover text-center"
                                            id="table" data-toggle="table" data-sortable="true" data-toolbar="#toolbar"
                                            data-filter-strict-search="true" data-filter-control="true">

                                            <thead class="thead-light" style="font-size: 14px;">
                                                <tr class="text-nowrap">
                                                    <th>攜帶</th>
                                                    <th data-filter-control="input" data-field="es_equipment_id"
                                                        data-sortable="true">資產標籤</th>
                                                    <th data-filter-control="input" data-field="es_equipment_type"
                                                        data-sortable="true">中類</th>
                                                    <th data-filter-control="input" data-field="es_equipment_name"
                                                        data-sortable="true">品名</th>
                                                </tr>
                                            </thead style="font-size: 14px;">
                                            <tbody>
                                                {% for e in all_Equipment %}

                                                <tr>
                                                    <td> <input type="checkbox" name="importcheckd"
                                                            onclick="update_all_Equipment_checkedArray(this)"
                                                            value="{{ e.id }}" /> </td>
                                                    <td>{{ e.equipment_id }} </td>
                                                    <td>{{ e.equipment_type }}</td>
                                                    <td>{{ e.equipment_name }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>

                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class=" d-flex justify-content-between">
                                <button type="submit" class="btn border border-dark rounded w-50 mx-4 "
                                    style="color: #fff;background: #1E3050;">送出</button>
                                <button type="button" class="btn border border-dark rounded w-50 mx-4 "
                                    style="color: #fff;background: #1E3050;" data-dismiss="modal">關閉</button>

                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="employee-assign-table container-fluid shadow-sm table-responsive">
        <table class="table table-sm table-hover text-center" id="table" data-toggle="table" data-sortable="true"
            data-toolbar="#toolbar" data-pagination="true" data-page-size="25" data-page-list="[25, All]"
            data-search="true" data-show-columns="true" data-filter-strict-search="true"
            data-show-columns-toggle-all="true">
            <div id="toolbar">
                <div class="employee-assign-header container-fluid">
                    <a href="" class="font-weight-bold" id="sys_new" data-toggle="modal"
                        data-target="#employee-assign-modal">
                        <i class="fa-solid fa-plus fa-sm" style="color: #000000;"></i> 新增派工單
                    </a>
                    <a href="" class="font-weight-bold" id="">
                        <i class="fa-solid fa-arrow-right-to-bracket" style="color: #000000;"></i> 匯入
                    </a>
                    <button onclick="exportAllOptionToExcel('派工單.xlsx')"
                        data-export-url="{% url 'excel_export' %}">匯出全部資料</button>
                    <button onclick="exportSelectedOptionToExcel('派工單.xlsx')">匯出已選資料</button>
                </div>
            </div>
            <thead class="thead-light" style="font-size: 14px;">
                <tr class="text-nowrap">
                    <th data-force-hide="true" data-switchable="false" data-no-print="true" data-field="checkbox">匯出</th>
                    <th data-force-hide="true" data-switchable="false" data-no-print="true" data-field="edid">編輯</th>
                    <th data-force-hide="true" data-switchable="false" data-no-print="true" data-field="delete">刪除</th>
                    <th data-force-hide="true" data-switchable="false" data-no-print="true" data-field="naelete">簽名</th>
                    <th data-force-hide="true" data-sortable="true" data-no-print="true" data-field="process">列印</th>

                    <th data-field="quotation_id" data-sortable="true">報價單號</th>
                    <th data-field="project_name" data-sortable="true">工程名稱</th>
                    <th data-field="lead_employee" data-sortable="true">帶班主管</th>
                    <th data-field="construction_date" data-sortable="true">施工日期</th>
                    <th data-field="completion_date" data-sortable="true">完工日期</th>
                    <th data-field="is_completed" data-sortable="true">是否完工</th>
                    <th data-field="client" data-sortable="true">客戶名稱</th>
                    <th data-field="requisition" data-sortable="true">請購單位</th>
                    <th data-field="construction_location" data-sortable="true">施工地點</th>
                    <th data-field="inspector" data-sortable="true">檢測人員</th>
                    <th data-field="vehicle" data-sortable="true">使用車輛</th>
                    <th data-field="manuscript_return_date" data-sortable="true">手稿預計回傳日</th>
                    <th data-field="enterprise_signature" data-sortable="true">業主簽名</th>
                </tr>
            </thead>
            <tbody class="text-nowrap" style="font-size: 14px;">
                {% for p in Project_Employee_Assign %}
                <tr>
                    <td><input type="checkbox" name="importcheckd" onclick="updateCheckedArray(this)"value="{{ j.id }}"></td>
                    <td>
                        <a type="button" data-url="project_employee_assign" data-id="{{p.id}}"
                            class="btn btn-sm btn-warning my-2 mx-md-2" data-toggle="modal"  onclick="LoadData(event)"
                            data-target="#employee-assign-modal"><i class="fas fa-sm fa-edit"></i></a>
                    </td>
                    <td>
                        <a data-url="project_employee_assign" data-id="{{p.id}}" type="button"
                            class="sys_del btn btn-sm btn-danger my-2 mx-md-2"><i
                                class="far fa-sm fa-trash-alt"></i></a>
                    </td>
                    <td>
                        <button type="button" class="btn btn-primary"  onclick="setSettingId('{{ p.id }}')"  data-toggle="modal" data-target="#signatureModal">
                            業主簽名
                        </button>
                    </td>
                    <td><a target="_blank" href="{% url 'project_employee_assign_View' id=p.id %}">列印</a></td>

                    
                    <td>{{ p.project_job_assign.project_confirmation.quotation_id }}</td>
                    <td>{{ p.project_job_assign.project_confirmation.project_name }}</td>
                    <td>{% for employees_list in p.lead_employee.all %}{{ employees_list.full_name }}<br>{% endfor %}</td>
                    <td>{{ p.construction_date }}</td>
                    <td>{{ p.completion_date }}</td>
                    <td>{% if p.is_completed %}是{% else %}否{% endif %}</td>
                    <td>{{ p.client }}</td>
                    <td>{{ p.requisition }}</td>
                    <td>{{ p.construction_location }}</td>
                    <td>{% for employees_list in p.inspector.all %}{{ employees_list.full_name }}<br>{% endfor %}</td>
                    <td>{{ p.vehicle }}</td>
                    <td>{{ p.manuscript_return_date }}</td>

                    <td>{{ p.enterprise_signature }}</td>
                </tr>
                {% empty %}

                <h2>
                    目前無資料
                </h2>
                {% endfor %}

            </tbody>
        </table>
    </div>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        var scripts = [
            "{% static 'js/fuc/restful.js' %}",
            "{% static 'js/fuc/LoadSelect.js' %}",
            "{% static 'js/employee_assign/employee_assign.js' %}",
            "{% static 'js/employee_assign/choose_Equipment.js' %}",
            "{% static 'js/employee_assign/signature_name.js' %}",
            "{% static 'js/bootstrap-table/checked_row.js' %}",
            "{% static 'js/bootstrap-table/exportAllOptionToExcel.js' %}",
            "{% static 'js/bootstrap-table/exportSelectedOptionToExcel.js' %}",
        ];

        scripts.forEach(function (src) {
            var script = document.createElement('script');
            script.src = src;
            document.body.appendChild(script);
        });
    });

    $(document).ready(function () {

        $('#Equipment_table').bootstrapTable({
            // height: $(window).height()*0.7,
            toolbar: "#toolbar",

        });

    });

    async function LoadData(event){
        console.log("load")
        getdata = await GET_handleClick(event,true);
        get_value = Object.values(getdata["carry_equipments"]);
        all_Equipment_checked = get_value;
        syncall_Equipment_checkedRowsWithArray();

        var choose_input = document.getElementById("project_job_assign_id");
        const change_event = new Event("change");
        choose_input.dispatchEvent(change_event);     


    }
</script>


{% endblock %}